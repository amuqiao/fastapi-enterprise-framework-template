### 6. 中间件模块

**核心作用**：处理请求/响应生命周期的横切逻辑

**设计特点**：
- 支持多种中间件
- 中间件顺序可控
- 支持自定义中间件
- 内置常用中间件（CORS、限流、日志、认证等）

**模块架构图**：
```mermaid
graph TD
    subgraph 中间件链
        A[CORS中间件] --> B[日志中间件]
        B --> E[请求ID中间件]
    end
    
    Client[客户端请求] --> 中间件链
    中间件链 --> Router[路由处理]
    Router --> 中间件链
    中间件链 --> Client
    
    style A fill:#FF6B6B,stroke:#2D3436,stroke-width:3px,color:white,rx:8,ry:8
    style B fill:#4ECDC4,stroke:#2D3436,stroke-width:2px,color:#2D3436,rx:8,ry:8
    style E fill:#95A5A6,stroke:#2D3436,stroke-width:2px,color:#2D3436,rx:8,ry:8
    style Client fill:#FECA57,stroke:#2D3436,stroke-width:2px,color:#2D3436,rx:8,ry:8
    style Router fill:#E9ECEF,stroke:#2D3436,stroke-width:3px,color:#2D3436,rx:8,ry:8
    style 中间件链 fill:#45B7D1,stroke:#2D3436,stroke-width:2px,color:white,rx:8,ry:8
```

**数据流转图**：
```mermaid
sequenceDiagram
    participant Client as 客户端
    participant CORS as CORS中间件
    participant Logging as 日志中间件
    participant RequestID as 请求ID中间件
    participant Router as 路由层
    
    Client->>CORS: 请求经过CORS中间件
    CORS->>Logging: 请求经过日志中间件
    Logging->>RequestID: 请求经过请求ID中间件
    RequestID->>Router: 请求到达路由层
    Router->>RequestID: 响应返回请求ID中间件
    RequestID->>Logging: 响应返回日志中间件
    Logging->>CORS: 响应返回CORS中间件
    CORS->>Client: 响应返回客户端
```

**关键实现**：
```python
# app/middleware/__init__.py
from app.middleware.cors import setup_cors
from app.middleware.request_logger import request_logger_middleware
from app.middleware.authentication import get_current_user, oauth2_scheme
from app.middleware.request import request_id_middleware


# main.py 中的中间件注册
def register_middlewares(app):
    """注册所有中间件"""
    # 1. 注册CORS中间件
    setup_cors(app)
    
    # 2. 注册日志中间件
    app.middleware("http")(request_logger_middleware)
    
    # 3. 注册请求ID中间件
    app.middleware("http")(request_id_middleware)
```