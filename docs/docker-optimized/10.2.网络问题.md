# 10.2 网络问题

## 10.2.1 容器无法访问外部网络

### 10.2.1.1 问题描述

容器无法访问外部网络，ping或curl外部地址失败：

```bash
# 示例错误信息
ping: google.com: Name or service not known
```

### 10.2.1.2 解决方案

#### 10.2.1.2.1 检查容器DNS配置

```bash
# 查看容器DNS配置
docker exec <container_name> cat /etc/resolv.conf

# 检查DNS服务器是否可访问
docker exec <container_name> ping -c 3 8.8.8.8
```

#### 10.2.1.2.2 配置DNS服务器

```bash
# 运行容器时指定DNS服务器
docker run -d --name <container_name> --dns 8.8.8.8 --dns 8.8.4.4 <image_name>

# 在daemon.json中配置默认DNS
# /etc/docker/daemon.json
{
  "dns": ["8.8.8.8", "8.8.4.4"]
}
```

#### 10.2.1.2.3 检查Docker网络配置

```bash
# 检查Docker默认网络
docker network inspect bridge

# 检查iptables规则
sudo iptables -L -n | grep DOCKER

# 重启Docker服务
sudo systemctl restart docker
```

## 10.2.2 外部无法访问容器端口

### 10.2.2.1 问题描述

外部无法访问容器映射的端口，curl或浏览器访问失败：

```bash
# 示例错误信息
curl: (7) Failed to connect to localhost port 8080: Connection refused
```

### 10.2.2.2 解决方案

#### 10.2.2.2.1 检查端口映射配置

```bash
# 检查容器端口映射
docker port <container_name>

# 检查容器是否在运行
docker ps | grep <container_name>
```

#### 10.2.2.2.2 检查容器内服务状态

```bash
# 检查容器内服务是否在运行
docker exec <container_name> ps aux | grep <service_name>

# 检查容器内端口是否在监听
docker exec <container_name> netstat -tuln
```

#### 10.2.2.2.3 检查宿主机防火墙

```bash
# 检查UFW状态
sudo ufw status

# 允许端口访问
sudo ufw allow <port>

# 检查iptables规则
sudo iptables -L -n | grep <port>
```

#### 10.2.2.2.4 检查宿主机IP地址

```bash
# 查看宿主机IP地址
ip addr

# 使用宿主机IP访问容器
curl http://<host_ip>:<port>
```

## 10.2.3 容器间无法通信

### 10.2.3.1 问题描述

同一网络内的容器无法相互通信，ping或curl失败：

```bash
# 示例错误信息
ping: container2: Name or service not known
```

### 10.2.3.2 解决方案

#### 10.2.3.2.1 检查容器是否在同一网络

```bash
# 检查容器网络配置
docker inspect --format='{{json .NetworkSettings.Networks}}' <container1>
docker inspect --format='{{json .NetworkSettings.Networks}}' <container2>

# 将容器连接到同一网络
docker network connect <network_name> <container_name>
```

#### 10.2.3.2.2 检查网络配置

```bash
# 检查网络详情
docker network inspect <network_name>

# 检查网络是否正常工作
docker run --rm --network <network_name> alpine ping -c 3 <container_name>
```

#### 10.2.3.2.3 使用容器名称或IP访问

```bash
# 使用容器名称访问
docker exec <container1> ping -c 3 <container2>

# 使用容器IP访问
docker exec <container1> ping -c 3 <container2_ip>
```

## 10.2.4 Docker网络冲突

### 10.2.4.1 问题描述

Docker网络与宿主机或其他网络冲突，导致网络不通：

```bash
# 示例错误信息
Error response from daemon: could not find an available, non-overlapping IPv4 address pool among the defaults to assign to the network
```

### 10.2.4.2 解决方案

#### 10.2.4.2.1 配置Docker默认地址池

```bash
# 在daemon.json中配置默认地址池
# /etc/docker/daemon.json
{
  "default-address-pools": [
    {
      "base": "172.31.0.0/16",
      "size": 24
    }
  ]
}

# 重启Docker服务
sudo systemctl restart docker
```

#### 10.2.4.2.2 创建网络时指定子网

```bash
# 创建自定义网络时指定子网
docker network create --subnet=192.168.100.0/24 <network_name>
```

## 10.2.5 容器网络性能问题

### 10.2.5.1 问题描述

容器网络性能不佳，网络延迟高或吞吐量低：

```bash
# 示例：ping延迟高
ping: statistics for 172.17.0.3: packets transmitted=10, packets received=10, packet loss=0%, round-trip time (ms): min=100.2, avg=250.5, max=500.1, stddev=125.3
```

### 10.2.5.2 解决方案

#### 10.2.5.2.1 选择合适的网络驱动

```bash
# 查看当前网络驱动
docker network inspect <network_name> | grep Driver

# 使用host网络提高性能
docker run -d --name <container_name> --network host <image_name>
```

#### 10.2.5.2.2 调整MTU设置

```bash
# 在daemon.json中配置MTU
# /etc/docker/daemon.json
{
  "mtu": 1450
}

# 重启Docker服务
sudo systemctl restart docker
```

#### 10.2.5.2.3 优化网络配置

```bash
# 禁用IPv6（如果不需要）
docker run -d --name <container_name> --sysctl net.ipv6.conf.all.disable_ipv6=1 <image_name>

# 调整TCP参数
docker run -d --name <container_name> --sysctl net.core.somaxconn=4096 <image_name>
```

## 10.2.6 Docker DNS解析问题

### 10.2.6.1 问题描述

容器内DNS解析失败，无法解析域名：

```bash
# 示例错误信息
nslookup: can't resolve 'google.com'
```

### 10.2.6.2 解决方案

#### 10.2.6.2.1 检查容器DNS配置

```bash
# 查看容器DNS配置
docker exec <container_name> cat /etc/resolv.conf
```

#### 10.2.6.2.2 配置自定义DNS服务器

```bash
# 运行容器时指定DNS服务器
docker run -d --name <container_name> --dns 8.8.8.8 --dns 8.8.4.4 <image_name>

# 在daemon.json中配置默认DNS
# /etc/docker/daemon.json
{
  "dns": ["8.8.8.8", "8.8.4.4"]
}
```

#### 10.2.6.2.3 检查Docker DNS服务

```bash
# 检查Docker DNS服务状态
docker ps | grep dnsmasq

# 重启Docker服务
sudo systemctl restart docker
```

## 10.2.7 最佳实践

1. **使用自定义网络**：避免使用默认bridge网络，提高网络隔离性
2. **合理规划网络**：不同服务使用不同网络，提高安全性
3. **最小化端口映射**：只映射必要的端口，减少暴露面
4. **配置健康检查**：确保容器正常运行
5. **使用服务发现**：在复杂环境中使用服务发现机制
6. **监控网络性能**：定期监控网络延迟和吞吐量
7. **使用IPv6（如果需要）**：合理配置IPv6网络
8. **定期清理网络**：删除未使用的网络，释放资源

## 10.2.8 常见网络问题汇总

| 问题类型 | 常见原因 | 解决方案 |
|---------|---------|---------|
| 容器无法访问外部网络 | DNS配置错误、网络隔离 | 检查DNS配置、重启Docker服务 |
| 外部无法访问容器端口 | 端口映射错误、防火墙拦截 | 检查端口映射、配置防火墙 |
| 容器间无法通信 | 不在同一网络、网络配置错误 | 将容器连接到同一网络、检查网络配置 |
| Docker网络冲突 | 子网重叠 | 配置自定义地址池、指定子网 |
| 容器网络性能问题 | 网络驱动选择不当、MTU设置不合理 | 使用host网络、调整MTU |
| Docker DNS解析问题 | DNS配置错误、DNS服务故障 | 配置自定义DNS服务器、重启Docker服务 |