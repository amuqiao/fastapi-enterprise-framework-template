# 10.3 存储问题

## 10.3.1 数据卷挂载失败

### 10.3.1.1 问题描述

挂载数据卷到容器时失败，出现错误信息：

```bash
# 示例错误信息
Error response from daemon: invalid mount config for type "volume": invalid mount path: 'data' mount path must be absolute
```

### 10.3.1.2 解决方案

#### 10.3.1.2.1 检查挂载路径格式

```bash
# 确保挂载路径是绝对路径
docker run -v /absolute/path:/container/path image
# 而非相对路径
docker run -v relative/path:/container/path image
```

#### 10.3.1.2.2 检查数据卷是否存在

```bash
# 查看数据卷列表
docker volume ls

# 创建数据卷
docker volume create <volume_name>
```

#### 10.3.1.2.3 检查宿主机路径权限

```bash
# 确保宿主机路径存在且有权限
mkdir -p /path/to/host/directory
chmod 777 /path/to/host/directory
```

## 10.3.2 容器数据丢失

### 10.3.2.1 问题描述

容器停止或删除后，数据丢失：

```bash
# 示例：容器删除后数据丢失
docker rm -f container
# 重新运行容器后，之前的数据不存在
```

### 10.3.2.2 解决方案

#### 10.3.2.2.1 使用持久化存储

```bash
# 使用named volume
docker run -d -v <volume_name>:/data <image_name>

# 使用bind mount
docker run -d -v /host/path:/data <image_name>
```

#### 10.3.2.2.2 备份数据卷

```bash
# 备份数据卷到tar文件
docker run --rm -v <volume_name>:/volume -v $(pwd):/backup ubuntu tar -czvf /backup/<volume_name>.tar.gz /volume

# 恢复数据卷
docker run --rm -v <volume_name>:/volume -v $(pwd):/backup ubuntu tar -xzvf /backup/<volume_name>.tar.gz -C /
```

#### 10.3.2.2.3 定期备份

```bash
# 创建备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d-%H%M%S)
docker run --rm -v <volume_name>:/volume -v /backup:/backup ubuntu tar -czvf /backup/<volume_name>-${DATE}.tar.gz /volume

# 定时执行备份
# 在crontab中添加
0 2 * * * /path/to/backup-script.sh
```

## 10.3.3 容器磁盘空间不足

### 10.3.3.1 问题描述

容器运行时出现磁盘空间不足错误：

```bash
# 示例错误信息
No space left on device
```

### 10.3.3.2 解决方案

#### 10.3.3.2.1 检查磁盘空间

```bash
# 检查宿主机磁盘空间
df -h

# 检查Docker存储使用情况
docker system df
```

#### 10.3.3.2.2 清理Docker资源

```bash
# 清理未使用的容器、镜像、网络和卷
docker system prune

# 清理未使用的镜像
docker image prune

# 清理未使用的卷
docker volume prune

# 清理特定镜像
docker rmi <image_id>
```

#### 10.3.3.2.3 扩展Docker存储

```bash
# 修改Docker数据目录
# 1. 停止Docker服务
systemctl stop docker

# 2. 复制现有数据
rsync -a /var/lib/docker/ /new/path/to/docker/

# 3. 修改daemon.json
# /etc/docker/daemon.json
{
  "data-root": "/new/path/to/docker"
}

# 4. 重启Docker服务
systemctl start docker
```

## 10.3.4 挂载卷权限问题

### 10.3.4.1 问题描述

容器无法写入挂载卷，出现权限拒绝错误：

```bash
# 示例错误信息
Permission denied when writing to /data
```

### 10.3.4.2 解决方案

#### 10.3.4.2.1 检查卷权限

```bash
# 检查宿主机目录权限
ls -la /host/path

# 更改权限
chmod 777 /host/path

# 更改所有者为容器用户ID
chown -R 1000:1000 /host/path
```

#### 10.3.4.2.2 运行时指定用户

```bash
# 运行容器时指定用户
docker run -d -v /host/path:/container/path -u $(id -u):$(id -g) <image_name>
```

#### 10.3.4.2.3 在Dockerfile中设置权限

```dockerfile
# 创建数据目录并设置权限
RUN mkdir -p /data && chown -R appuser:appuser /data
USER appuser
```

## 10.3.5 数据卷备份和恢复

### 10.3.5.1 问题描述

需要备份和恢复数据卷，但不知道如何操作：

```bash
# 示例：需要备份数据卷
docker volume ls
```

### 10.3.5.2 解决方案

#### 10.3.5.2.1 使用容器备份数据卷

```bash
# 备份数据卷
docker run --rm -v <volume_name>:/volume -v $(pwd):/backup ubuntu tar -czvf /backup/<volume_name>.tar.gz /volume

# 恢复数据卷
docker volume create <volume_name>
docker run --rm -v <volume_name>:/volume -v $(pwd):/backup ubuntu tar -xzvf /backup/<volume_name>.tar.gz -C /
```

#### 10.3.5.2.2 使用docker cp命令

```bash
# 从容器复制数据到宿主机
docker cp container:/container/path /host/path

# 从宿主机复制数据到容器
docker cp /host/path container:/container/path
```

## 10.3.6 存储驱动问题

### 10.3.6.1 问题描述

Docker存储驱动导致性能问题或兼容性问题：

```bash
# 示例错误信息
Error starting daemon: error initializing graphdriver: overlay2: the backing xfs filesystem is formatted without d_type support, which is required by overlay2
```

### 10.3.6.2 解决方案

#### 10.3.6.2.1 检查存储驱动

```bash
# 查看当前存储驱动
docker info | grep Storage
```

#### 10.3.6.2.2 修改存储驱动

```bash
# 在daemon.json中配置存储驱动
# /etc/docker/daemon.json
{
  "storage-driver": "overlay2"
}

# 重启Docker服务
systemctl restart docker
```

#### 10.3.6.2.3 确保文件系统支持

```bash
# 检查文件系统是否支持d_type
xfs_info /var/lib/docker | grep -i ftype
```

## 10.3.7 最佳实践

1. **使用持久化存储**：避免数据丢失
2. **定期备份数据**：防止数据损坏或丢失
3. **使用named volumes**：便于管理和备份
4. **监控磁盘空间**：定期检查Docker存储使用情况
5. **选择合适的存储驱动**：根据系统环境选择合适的存储驱动
6. **合理规划存储空间**：根据应用需求规划存储空间
7. **使用存储插件**：在需要高级存储功能时使用存储插件
8. **清理未使用的资源**：定期清理未使用的容器、镜像和数据卷

## 10.3.8 常见存储问题汇总

| 问题类型 | 常见原因 | 解决方案 |
|---------|---------|---------|
| 数据卷挂载失败 | 挂载路径格式错误、数据卷不存在 | 确保使用绝对路径、创建数据卷 |
| 容器数据丢失 | 未使用持久化存储 | 使用named volume或bind mount |
| 容器磁盘空间不足 | Docker资源占用过多 | 清理Docker资源、扩展存储空间 |
| 挂载卷权限问题 | 宿主机路径权限不足 | 更改路径权限、指定容器用户 |
| 数据卷备份和恢复 | 不知道如何操作 | 使用容器备份、docker cp命令 |
| 存储驱动问题 | 存储驱动不兼容或配置错误 | 检查存储驱动、修改配置 |