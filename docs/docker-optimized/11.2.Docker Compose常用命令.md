# 11.2 Docker Compose常用命令

## 11.2.1 基本命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker-compose up` | 创建并启动服务 | `docker-compose up -d` |
| `docker-compose down` | 停止并删除服务、网络、卷 | `docker-compose down -v` |
| `docker-compose start` | 启动服务 | `docker-compose start` |
| `docker-compose stop` | 停止服务 | `docker-compose stop` |
| `docker-compose restart` | 重启服务 | `docker-compose restart` |
| `docker-compose pause` | 暂停服务 | `docker-compose pause` |
| `docker-compose unpause` | 恢复暂停的服务 | `docker-compose unpause` |
| `docker-compose ps` | 列出服务容器 | `docker-compose ps` |

## 11.2.2 构建与部署命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker-compose build` | 构建服务镜像 | `docker-compose build` |
| `docker-compose build --no-cache` | 构建服务镜像（不使用缓存） | `docker-compose build --no-cache` |
| `docker-compose pull` | 拉取服务镜像 | `docker-compose pull` |
| `docker-compose push` | 推送服务镜像 | `docker-compose push` |
| `docker-compose up --build` | 构建并启动服务 | `docker-compose up -d --build` |
| `docker-compose scale` | 扩展服务实例数量 | `docker-compose scale web=3` |
| `docker-compose up --scale` | 启动并扩展服务 | `docker-compose up -d --scale web=3` |

## 11.2.3 日志与监控命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker-compose logs` | 查看服务日志 | `docker-compose logs` |
| `docker-compose logs -f` | 实时查看服务日志 | `docker-compose logs -f` |
| `docker-compose logs <service>` | 查看特定服务日志 | `docker-compose logs -f web` |
| `docker-compose logs --tail` | 查看最近N行日志 | `docker-compose logs --tail 100` |
| `docker-compose logs -t` | 查看带时间戳的日志 | `docker-compose logs -t` |
| `docker-compose top` | 查看服务进程 | `docker-compose top` |

## 11.2.4 执行命令与调试

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker-compose exec` | 在服务容器内执行命令 | `docker-compose exec web sh` |
| `docker-compose run` | 运行一次性命令 | `docker-compose run web python manage.py migrate` |
| `docker-compose config` | 验证并查看配置 | `docker-compose config` |
| `docker-compose config --services` | 列出服务名称 | `docker-compose config --services` |
| `docker-compose config --volumes` | 列出卷名称 | `docker-compose config --volumes` |
| `docker-compose inspect` | 查看服务容器详细信息 | `docker-compose inspect web` |

## 11.2.5 系统与资源命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker-compose events` | 查看服务事件 | `docker-compose events` |
| `docker-compose port` | 查看服务端口映射 | `docker-compose port web 80` |
| `docker-compose ps` | 查看服务容器状态 | `docker-compose ps` |
| `docker-compose images` | 查看服务镜像 | `docker-compose images` |
| `docker-compose down --rmi all` | 停止并删除服务、网络、卷和镜像 | `docker-compose down -v --rmi all` |

## 11.2.6 环境与变量命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker-compose --env-file` | 使用指定的环境文件 | `docker-compose --env-file .env.prod up -d` |
| `docker-compose -f` | 使用指定的配置文件 | `docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d` |
| `docker-compose config --env` | 查看环境变量 | `docker-compose config --env` |
| `docker-compose run -e` | 运行命令时设置环境变量 | `docker-compose run -e DEBUG=1 web python manage.py shell` |

## 11.2.7 常用选项说明

### 11.2.7.1 `docker-compose up` 常用选项

| 选项 | 描述 | 示例 |
|------|------|------|
| `-d` | 后台运行服务 | `docker-compose up -d` |
| `--build` | 构建服务镜像 | `docker-compose up -d --build` |
| `--force-recreate` | 强制重新创建容器 | `docker-compose up -d --force-recreate` |
| `--no-deps` | 不启动依赖服务 | `docker-compose up -d --no-deps web` |
| `--scale` | 扩展服务实例数量 | `docker-compose up -d --scale web=3` |

### 11.2.7.2 `docker-compose down` 常用选项

| 选项 | 描述 | 示例 |
|------|------|------|
| `-v` | 删除卷 | `docker-compose down -v` |
| `--rmi all` | 删除所有服务镜像 | `docker-compose down --rmi all` |
| `--remove-orphans` | 删除未在配置中定义的容器 | `docker-compose down --remove-orphans` |

### 11.2.7.3 `docker-compose logs` 常用选项

| 选项 | 描述 | 示例 |
|------|------|------|
| `-f` | 实时查看日志 | `docker-compose logs -f` |
| `--tail` | 显示最后N行日志 | `docker-compose logs --tail 100` |
| `-t` | 显示时间戳 | `docker-compose logs -t` |
| `--no-color` | 不使用彩色输出 | `docker-compose logs --no-color` |

## 11.2.8 命令组合使用示例

### 11.2.8.1 开发环境部署

```bash
# 构建并启动开发环境
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f

# 进入 web 服务容器
docker-compose exec web sh

# 停止开发环境
docker-compose -f docker-compose.yml -f docker-compose.dev.yml down -v
```

### 11.2.8.2 生产环境部署

```bash
# 拉取生产环境镜像
docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull

# 启动生产环境
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 监控生产环境日志
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

# 查看 web 服务进程
docker-compose -f docker-compose.yml -f docker-compose.prod.yml top web

# 扩展 web 服务实例
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --scale web=3
```

### 11.2.8.3 数据库管理

```bash
# 启动数据库服务
docker-compose up -d db

# 初始化数据库
docker-compose run web python manage.py migrate

# 创建超级用户
docker-compose run web python manage.py createsuperuser

# 导出数据库
docker-compose exec db mysqldump -u root -p<root_password> <db_name> > dump.sql

# 导入数据库
docker-compose exec -T db mysql -u root -p<root_password> <db_name> < dump.sql
```

## 11.2.9 Docker Compose V2 命令

Docker Compose V2 是 Docker CLI 的插件，使用 `docker compose` 命令（注意没有连字符）：

```bash
# Docker Compose V2 命令示例
docker compose up -d
docker compose down -v
docker compose logs -f
docker compose exec web sh
docker compose build
```

### 11.2.9.1 启用 Docker Compose V2

```bash
# 启用 Docker Compose V2（Linux）
export DOCKER_CLI_EXPERIMENTAL=enabled

# 检查 Docker Compose V2 是否可用
docker compose version
```

## 11.2.10 最佳实践

1. **使用多个配置文件**：分离基础配置和环境特定配置
2. **使用环境变量**：避免硬编码配置
3. **使用命名卷**：便于管理和备份
4. **配置健康检查**：确保服务正常运行
5. **使用明确的镜像标签**：避免使用 `latest` 标签
6. **限制资源使用**：为服务配置资源限制
7. **清理未使用的资源**：定期运行 `docker-compose down -v --rmi all`
8. **监控服务日志**：使用集中式日志管理系统
9. **使用 Docker Compose V2**：享受更好的性能和新特性
10. **自动化部署**：将 Docker Compose 集成到 CI/CD 流程