# 11.3 资源清理命令

## 11.3.1 资源使用情况查看

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker system df` | 查看 Docker 资源使用情况 | `docker system df` |
| `docker system df -v` | 查看 Docker 资源使用详情 | `docker system df -v` |
| `docker images` | 查看本地镜像 | `docker images` |
| `docker images -a` | 查看所有本地镜像（包括中间层） | `docker images -a` |
| `docker ps` | 查看运行中的容器 | `docker ps` |
| `docker ps -a` | 查看所有容器 | `docker ps -a` |
| `docker network ls` | 查看网络 | `docker network ls` |
| `docker volume ls` | 查看数据卷 | `docker volume ls` |

## 11.3.2 容器清理命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker rm <container>` | 删除指定容器 | `docker rm mycontainer` |
| `docker rm -f <container>` | 强制删除运行中的容器 | `docker rm -f mycontainer` |
| `docker rm $(docker ps -a -q)` | 删除所有已停止的容器 | `docker rm $(docker ps -a -q)` |
| `docker container prune` | 删除所有已停止的容器 | `docker container prune` |
| `docker container prune -f` | 强制删除所有已停止的容器（不提示） | `docker container prune -f` |
| `docker rm $(docker ps -f status=exited -q)` | 删除状态为 exited 的容器 | `docker rm $(docker ps -f status=exited -q)` |
| `docker rm $(docker ps -f status=created -q)` | 删除状态为 created 的容器 | `docker rm $(docker ps -f status=created -q)` |

## 11.3.3 镜像清理命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker rmi <image>` | 删除指定镜像 | `docker rmi myimage:1.0` |
| `docker rmi -f <image>` | 强制删除镜像 | `docker rmi -f myimage:1.0` |
| `docker rmi $(docker images -q)` | 删除所有镜像 | `docker rmi $(docker images -q)` |
| `docker image prune` | 删除所有悬空镜像 | `docker image prune` |
| `docker image prune -a` | 删除所有未使用的镜像 | `docker image prune -a` |
| `docker image prune -a -f` | 强制删除所有未使用的镜像（不提示） | `docker image prune -a -f` |
| `docker rmi $(docker images -f dangling=true -q)` | 删除悬空镜像 | `docker rmi $(docker images -f dangling=true -q)` |
| `docker rmi $(docker images -f "before=<image>" -q)` | 删除指定镜像之前的所有镜像 | `docker rmi $(docker images -f "before=ubuntu:22.04" -q)` |

## 11.3.4 网络清理命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker network rm <network>` | 删除指定网络 | `docker network rm mynetwork` |
| `docker network rm $(docker network ls -q)` | 删除所有网络 | `docker network rm $(docker network ls -q)` |
| `docker network prune` | 删除所有未使用的网络 | `docker network prune` |
| `docker network prune -f` | 强制删除所有未使用的网络（不提示） | `docker network prune -f` |
| `docker network rm $(docker network ls -f type=bridge -q)` | 删除所有 bridge 类型网络 | `docker network rm $(docker network ls -f type=bridge -q)` |

## 11.3.5 数据卷清理命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker volume rm <volume>` | 删除指定数据卷 | `docker volume rm myvolume` |
| `docker volume rm -f <volume>` | 强制删除数据卷 | `docker volume rm -f myvolume` |
| `docker volume rm $(docker volume ls -q)` | 删除所有数据卷 | `docker volume rm $(docker volume ls -q)` |
| `docker volume prune` | 删除所有未使用的数据卷 | `docker volume prune` |
| `docker volume prune -f` | 强制删除所有未使用的数据卷（不提示） | `docker volume prune -f` |
| `docker volume rm $(docker volume ls -f dangling=true -q)` | 删除悬空数据卷 | `docker volume rm $(docker volume ls -f dangling=true -q)` |

## 11.3.6 构建缓存清理命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker builder prune` | 删除所有未使用的构建缓存 | `docker builder prune` |
| `docker builder prune -f` | 强制删除所有未使用的构建缓存（不提示） | `docker builder prune -f` |
| `docker builder prune -a` | 删除所有构建缓存 | `docker builder prune -a` |
| `docker builder prune -a -f` | 强制删除所有构建缓存（不提示） | `docker builder prune -a -f` |

## 11.3.7 系统级清理命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker system prune` | 删除所有未使用的资源（容器、网络、镜像、构建缓存） | `docker system prune` |
| `docker system prune -a` | 删除所有未使用的资源（包括未使用的镜像） | `docker system prune -a` |
| `docker system prune -a -f` | 强制删除所有未使用的资源（不提示） | `docker system prune -a -f` |
| `docker system prune --volumes` | 删除所有未使用的资源，包括数据卷 | `docker system prune --volumes` |
| `docker system prune -a --volumes` | 删除所有未使用的资源，包括未使用的镜像和数据卷 | `docker system prune -a --volumes` |

## 11.3.8 组合清理命令

### 11.3.8.1 清理所有停止的容器和悬空镜像

```bash
docker container prune -f && docker image prune -f
```

### 11.3.8.2 清理所有未使用的资源

```bash
docker system prune -a --volumes -f
```

### 11.3.8.3 清理特定镜像

```bash
# 删除所有包含 "old" 关键字的镜像
docker rmi $(docker images | grep "old" | awk '{print $3}')

# 删除所有超过 7 天的镜像
docker rmi $(docker images | grep -v "none" | awk '{if ($4 < 7) print $3}')
```

### 11.3.8.4 清理所有资源（危险操作）

```bash
# 停止所有运行中的容器
docker stop $(docker ps -q)

# 删除所有容器
docker rm -f $(docker ps -a -q)

# 删除所有镜像
docker rmi -f $(docker images -q)

# 删除所有网络
docker network rm $(docker network ls -q)

# 删除所有数据卷
docker volume rm $(docker volume ls -q)
```

## 11.3.9 Docker Compose 资源清理

| 命令 | 描述 | 示例 |
|------|------|------|
| `docker-compose down` | 停止并删除服务、网络、卷 | `docker-compose down` |
| `docker-compose down -v` | 停止并删除服务、网络、卷 | `docker-compose down -v` |
| `docker-compose down --rmi all` | 停止并删除服务、网络、卷和所有镜像 | `docker-compose down -v --rmi all` |
| `docker-compose down --remove-orphans` | 删除未在配置中定义的容器 | `docker-compose down --remove-orphans` |
| `docker-compose rm` | 删除已停止的服务容器 | `docker-compose rm` |
| `docker-compose rm -f` | 强制删除服务容器 | `docker-compose rm -f` |
| `docker-compose rm -v` | 删除服务容器和相关卷 | `docker-compose rm -v` |

## 11.3.10 清理最佳实践

1. **定期清理**：定期执行清理命令，释放存储空间
2. **使用 `docker system prune`**：这是最全面的清理命令
3. **谨慎使用 `-f` 选项**：避免误删重要资源
4. **备份重要数据**：在清理数据卷前，确保已备份重要数据
5. **使用标签管理资源**：为容器、镜像和卷添加标签，便于管理和清理
6. **清理前检查**：在执行清理命令前，先查看资源使用情况
7. **在测试环境中验证**：在生产环境执行清理命令前，先在测试环境验证
8. **自动化清理**：将清理命令添加到定时任务中，自动执行

### 11.3.10.1 创建清理脚本

```bash
#!/bin/bash
# Docker 资源清理脚本

echo "=== Docker 资源清理开始 ==="
echo "当前时间: $(date)"
echo ""

# 查看清理前资源使用情况
echo "=== 清理前资源使用情况 ==="
docker system df -v
echo ""

# 停止所有运行中的容器
echo "=== 停止所有运行中的容器 ==="
docker stop $(docker ps -q 2>/dev/null) 2>/dev/null
echo ""

# 删除所有已停止的容器
echo "=== 删除所有已停止的容器 ==="
docker container prune -f
echo ""

# 删除所有悬空镜像
echo "=== 删除所有悬空镜像 ==="
docker image prune -f
echo ""

# 删除所有未使用的镜像
echo "=== 删除所有未使用的镜像 ==="
docker image prune -a -f
echo ""

# 删除所有未使用的网络
echo "=== 删除所有未使用的网络 ==="
docker network prune -f
echo ""

# 删除所有未使用的数据卷
echo "=== 删除所有未使用的数据卷 ==="
docker volume prune -f
echo ""

# 查看清理后资源使用情况
echo "=== 清理后资源使用情况 ==="
docker system df -v
echo ""

echo "=== Docker 资源清理完成 ==="
echo "结束时间: $(date)"
```

### 11.3.10.2 定时执行清理脚本

```bash
# 将清理脚本添加到 crontab，每周日凌晨 2 点执行
0 2 * * 0 /path/to/docker-cleanup.sh >> /var/log/docker-cleanup.log 2>&1
```

## 11.3.11 注意事项

1. **数据丢失风险**：清理数据卷时，会删除卷中的所有数据，请确保已备份重要数据
2. **服务中断风险**：清理运行中的容器时，会导致服务中断
3. **镜像重新拉取**：清理镜像后，下次运行容器时需要重新拉取镜像，可能会增加启动时间
4. **网络连接中断**：清理网络时，可能会导致容器网络连接中断
5. **构建缓存丢失**：清理构建缓存后，下次构建镜像时需要重新构建，可能会增加构建时间

在执行清理命令前，请仔细考虑这些风险，并确保已采取适当的预防措施。