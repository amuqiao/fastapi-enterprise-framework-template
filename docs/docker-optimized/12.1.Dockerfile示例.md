# 12.1 Dockerfile示例

## 12.1.1 Python 示例

### 12.1.1.1 Flask 应用

```dockerfile
# 基础镜像
FROM python:3.10-alpine

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 安装依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 5000

# 启动命令
CMD ["python", "app.py"]
```

### 12.1.1.2 Django 应用

```dockerfile
# 多阶段构建
# 构建阶段
FROM python:3.10 AS builder

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 运行阶段
FROM python:3.10-slim

WORKDIR /app

COPY --from=builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

COPY . .

# 运行迁移和收集静态文件
RUN python manage.py migrate
RUN python manage.py collectstatic --noinput

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["gunicorn", "myproject.wsgi:application", "--bind", "0.0.0.0:8000"]
```

### 12.1.1.3 FastAPI 应用

```dockerfile
# 使用官方 Python 镜像作为基础镜像
FROM python:3.10-alpine

# 设置环境变量
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apk add --no-cache gcc musl-dev linux-headers

# 复制依赖文件
COPY requirements.txt .

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建非 root 用户
RUN addgroup -g 1001 -S appgroup && \
    adduser -S appuser -u 1001

# 切换到非 root 用户
USER appuser

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

## 12.1.2 Node.js 示例

### 12.1.2.1 Express 应用

```dockerfile
# 使用官方 Node.js 镜像作为基础镜像
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制 package.json 和 package-lock.json
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 3000

# 启动命令
CMD ["node", "app.js"]
```

### 12.1.2.2 React 应用

```dockerfile
# 多阶段构建
# 构建阶段
FROM node:18-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

# 运行阶段
FROM nginx:alpine

COPY --from=builder /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 12.1.2.3 Next.js 应用

```dockerfile
# 使用官方 Node.js 镜像作为基础镜像
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制 package.json 和 package-lock.json
COPY package*.json ./

# 安装依赖
RUN npm ci

# 复制应用代码
COPY . .

# 构建应用
RUN npm run build

# 暴露端口
EXPOSE 3000

# 启动命令
CMD ["npm", "start"]
```

## 12.1.3 Java 示例

### 12.1.3.1 Spring Boot 应用

```dockerfile
# 多阶段构建
# 构建阶段
FROM maven:3.8.5-openjdk-17 AS builder

WORKDIR /app

COPY pom.xml .
RUN mvn dependency:go-offline

COPY src ./src
RUN mvn package -DskipTests

# 运行阶段
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY --from=builder /app/target/*.jar app.jar

# 暴露端口
EXPOSE 8080

# 启动命令
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 12.1.3.2 Gradle 应用

```dockerfile
# 多阶段构建
# 构建阶段
FROM gradle:7.6-jdk17 AS builder

WORKDIR /app

COPY build.gradle settings.gradle ./
COPY src ./src

RUN gradle build --no-daemon

# 运行阶段
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY --from=builder /app/build/libs/*.jar app.jar

# 暴露端口
EXPOSE 8080

# 启动命令
ENTRYPOINT ["java", "-jar", "app.jar"]
```

## 12.1.4 Go 示例

### 12.1.4.1 简单 Go 应用

```dockerfile
# 多阶段构建
# 构建阶段
FROM golang:1.20-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .

# 运行阶段
FROM alpine:3.16

WORKDIR /app

COPY --from=builder /app/app .

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["./app"]
```

### 12.1.4.2 Gin 框架应用

```dockerfile
# 多阶段构建
# 构建阶段
FROM golang:1.20-alpine AS builder

WORKDIR /app

# 安装依赖
RUN apk add --no-cache git

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .

# 运行阶段
FROM alpine:3.16

WORKDIR /app

COPY --from=builder /app/app .

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["./app"]
```

## 12.1.5 PHP 示例

### 12.1.5.1 Laravel 应用

```dockerfile
# 多阶段构建
# 构建阶段
FROM composer:2.5 as builder

WORKDIR /app

COPY composer.json composer.lock ./
RUN composer install --no-dev --optimize-autoloader

COPY . .
RUN php artisan optimize

# 运行阶段
FROM php:8.2-fpm-alpine

WORKDIR /app

# 安装 PHP 扩展
RUN docker-php-ext-install pdo_mysql

# 复制依赖
COPY --from=builder /app/vendor /app/vendor
COPY --from=builder /app/public /app/public
COPY --from=builder /app/artisan /app/artisan
COPY --from=builder /app/bootstrap /app/bootstrap
COPY --from=builder /app/config /app/config
COPY --from=builder /app/database /app/database
COPY --from=builder /app/resources /app/resources
COPY --from=builder /app/routes /app/routes
COPY --from=builder /app/storage /app/storage
COPY --from=builder /app/tests /app/tests
COPY --from=builder /app/.env.example /app/.env.example

# 设置权限
RUN chown -R www-data:www-data /app/storage /app/bootstrap/cache

# 暴露端口
EXPOSE 9000

# 启动命令
CMD ["php-fpm"]
```

### 12.1.5.2 WordPress 应用

```dockerfile
# 使用官方 WordPress 镜像作为基础镜像
FROM wordpress:6.2-php8.2-apache

# 复制自定义配置
COPY wp-config.php /var/www/html/

# 复制主题和插件
COPY ./themes /var/www/html/wp-content/themes/
COPY ./plugins /var/www/html/wp-content/plugins/

# 设置权限
RUN chown -R www-data:www-data /var/www/html/wp-content

# 暴露端口
EXPOSE 80

# 启动命令
CMD ["apache2-foreground"]
```

## 12.1.6 Rust 示例

### 12.1.6.1 简单 Rust 应用

```dockerfile
# 多阶段构建
# 构建阶段
FROM rust:1.69 as builder

WORKDIR /app

COPY Cargo.toml Cargo.lock ./
RUN cargo fetch

COPY src ./src
RUN cargo build --release

# 运行阶段
FROM debian:bullseye-slim

WORKDIR /app

COPY --from=builder /app/target/release/app .

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["./app"]
```

## 12.1.7 数据库示例

### 12.1.7.1 MySQL 数据库

```dockerfile
# 使用官方 MySQL 镜像作为基础镜像
FROM mysql:8.0

# 设置环境变量
ENV MYSQL_ROOT_PASSWORD=root_password
ENV MYSQL_DATABASE=myapp
ENV MYSQL_USER=myuser
ENV MYSQL_PASSWORD=mypassword

# 复制初始化脚本
COPY init.sql /docker-entrypoint-initdb.d/

# 暴露端口
EXPOSE 3306

# 启动命令
CMD ["mysqld"]
```

### 12.1.7.2 PostgreSQL 数据库

```dockerfile
# 使用官方 PostgreSQL 镜像作为基础镜像
FROM postgres:15

# 设置环境变量
ENV POSTGRES_PASSWORD=postgres
ENV POSTGRES_USER=postgres
ENV POSTGRES_DB=myapp

# 复制初始化脚本
COPY init.sql /docker-entrypoint-initdb.d/

# 暴露端口
EXPOSE 5432

# 启动命令
CMD ["postgres"]
```

## 12.1.8 其他示例

### 12.1.8.1 Nginx 反向代理

```dockerfile
# 使用官方 Nginx 镜像作为基础镜像
FROM nginx:alpine

# 复制自定义配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 复制静态文件
COPY ./html /usr/share/nginx/html

# 暴露端口
EXPOSE 80
EXPOSE 443

# 启动命令
CMD ["nginx", "-g", "daemon off;"]
```

### 12.1.8.2 Redis 缓存

```dockerfile
# 使用官方 Redis 镜像作为基础镜像
FROM redis:7-alpine

# 复制自定义配置
COPY redis.conf /usr/local/etc/redis/redis.conf

# 暴露端口
EXPOSE 6379

# 启动命令
CMD ["redis-server", "/usr/local/etc/redis/redis.conf"]
```

## 12.1.9 最佳实践示例

### 12.1.9.1 多阶段构建

```dockerfile
# 第一阶段：构建阶段
FROM golang:1.20-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .

# 第二阶段：运行阶段
FROM alpine:3.16

WORKDIR /app

# 安装必要的依赖
RUN apk add --no-cache ca-certificates tzdata

# 设置时区
ENV TZ=Asia/Shanghai

# 创建非 root 用户
RUN addgroup -g 1001 -S appgroup && \
    adduser -S appuser -u 1001

# 复制应用
COPY --from=builder /app/app .

# 切换到非 root 用户
USER appuser

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD wget -qO- http://localhost:8080/health || exit 1

# 启动命令
CMD ["./app"]
```

### 12.1.9.2 完整的 Web 应用栈

```dockerfile
# 这是一个完整的 Web 应用栈示例，包括前端、后端和数据库
# 实际使用时，建议拆分为多个 Dockerfile

# 前端构建阶段
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci
COPY frontend/ ./
RUN npm run build

# 后端构建阶段
FROM python:3.10-alpine AS backend-builder
WORKDIR /app/backend
COPY backend/requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
COPY backend/ ./
RUN python manage.py collectstatic --noinput

# 运行阶段
FROM python:3.10-alpine

WORKDIR /app

# 复制前端构建结果
COPY --from=frontend-builder /app/frontend/build /app/static

# 复制后端构建结果
COPY --from=backend-builder /app/backend /app
COPY --from=backend-builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=backend-builder /usr/local/bin /usr/local/bin

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["gunicorn", "myapp.wsgi:application", "--bind", "0.0.0.0:8000"]
```

## 12.1.10 Dockerfile 编写技巧

1. **使用官方基础镜像**：确保镜像的安全性和可靠性
2. **使用多阶段构建**：减小最终镜像体积，提高构建速度
3. **最小化镜像层数**：合并 RUN 指令，减少镜像层数
4. **清理构建残留**：在 RUN 指令中清理临时文件
5. **使用 .dockerignore 文件**：排除不必要的文件和目录
6. **设置合理的 WORKDIR**：便于后续指令的执行
7. **使用非 root 用户**：提高容器安全性
8. **配置健康检查**：确保容器正常运行
9. **使用明确的标签**：避免使用 latest 标签
10. **添加详细的注释**：提高 Dockerfile 的可读性和可维护性

这些示例涵盖了不同编程语言和框架的 Dockerfile 编写方法，您可以根据自己的项目需求进行修改和扩展。