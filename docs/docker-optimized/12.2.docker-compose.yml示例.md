# 12.2 docker-compose.yml示例

## 12.2.1 基础示例

### 12.2.1.1 简单Web应用

```yaml
version: '3.8'

services:
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./html:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    restart: always
```

### 12.2.1.2 Web应用 + 数据库

```yaml
version: '3.8'

services:
  web:
    image: php:8.2-apache
    ports:
      - "80:80"
    volumes:
      - ./html:/var/www/html
    depends_on:
      - db
    restart: always

  db:
    image: mysql:8.0
    volumes:
      - mysql-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: myapp
      MYSQL_USER: myuser
      MYSQL_PASSWORD: mypassword
    restart: always

volumes:
  mysql-data:
```

## 12.2.2 Web应用示例

### 12.2.2.1 WordPress应用

```yaml
version: '3.8'

services:
  wordpress:
    image: wordpress:6.2-php8.2-apache
    ports:
      - "80:80"
    volumes:
      - wordpress-data:/var/www/html
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_NAME: wordpress
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress_password
    depends_on:
      - db
    restart: always

  db:
    image: mysql:8.0
    volumes:
      - mysql-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress_password
    restart: always

volumes:
  wordpress-data:
  mysql-data:
```

### 12.2.2.2 Django应用

```yaml
version: '3.8'

services:
  web:
    build: .
    command: gunicorn myproject.wsgi:application --bind 0.0.0.0:8000
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - static-volume:/app/static
      - media-volume:/app/media
    environment:
      - DEBUG=False
      - SECRET_KEY=your-secret-key
      - DB_NAME=myproject
      - DB_USER=myproject
      - DB_PASSWORD=myproject
      - DB_HOST=db
      - DB_PORT=5432
    depends_on:
      - db
      - redis
    restart: always

  db:
    image: postgres:15
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: myproject
      POSTGRES_USER: myproject
      POSTGRES_PASSWORD: myproject
    restart: always

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    restart: always

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - static-volume:/static
      - media-volume:/media
    depends_on:
      - web
    restart: always

volumes:
  postgres-data:
  redis-data:
  static-volume:
  media-volume:
```

## 12.2.3 微服务示例

### 12.2.3.1 简单微服务架构

```yaml
version: '3.8'

services:
  gateway:
    image: myapp/gateway:1.0
    ports:
      - "80:8080"
    depends_on:
      - user-service
      - order-service
      - product-service
    restart: always

  user-service:
    image: myapp/user-service:1.0
    depends_on:
      - user-db
      - rabbitmq
    restart: always

  order-service:
    image: myapp/order-service:1.0
    depends_on:
      - order-db
      - rabbitmq
      - user-service
    restart: always

  product-service:
    image: myapp/product-service:1.0
    depends_on:
      - product-db
      - rabbitmq
    restart: always

  user-db:
    image: postgres:15
    volumes:
      - user-db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: user_db
      POSTGRES_PASSWORD: user_db
    restart: always

  order-db:
    image: postgres:15
    volumes:
      - order-db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: order_db
      POSTGRES_USER: order_db
      POSTGRES_PASSWORD: order_db
    restart: always

  product-db:
    image: postgres:15
    volumes:
      - product-db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: product_db
      POSTGRES_PASSWORD: product_db
    restart: always

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    restart: always

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    restart: always

volumes:
  user-db-data:
  order-db-data:
  product-db-data:
  rabbitmq-data:
  redis-data:
```

## 12.2.4 开发环境示例

### 12.2.4.1 开发环境配置

```yaml
version: '3.8'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - API_URL=http://api:3001
    depends_on:
      - api
    restart: always

  api:
    build:
      context: ./api
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3001"
    volumes:
      - ./api:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - DB_URL=mongodb://db:27017/devdb
    depends_on:
      - db
    restart: always

  db:
    image: mongo:5.0
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    restart: always

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: always

volumes:
  mongo-data:
  redis-data:
```

## 12.2.5 生产环境示例

### 12.2.5.1 生产环境配置

```yaml
version: '3.8'

services:
  web:
    image: myapp/web:1.0
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ssl:/etc/nginx/ssl
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - static-volume:/app/static
      - media-volume:/app/media
    environment:
      - NODE_ENV=production
      - API_URL=http://api:3001
    depends_on:
      - api
    restart: always

  api:
    image: myapp/api:1.0
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DB_URL=mongodb://db:27017/proddb
      - JWT_SECRET=your-secret-key
    depends_on:
      - db
      - redis
    restart: always
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M

  db:
    image: mongo:5.0
    volumes:
      - mongo-data:/data/db
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 512M

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M

volumes:
  mongo-data:
  redis-data:
  static-volume:
  media-volume:
```

## 12.2.6 数据库示例

### 12.2.6.1 MySQL主从复制

```yaml
version: '3.8'

services:
  master:
    image: mysql:8.0
    command: --server-id=1 --log-bin=mysql-bin --binlog-format=ROW
    volumes:
      - master-data:/var/lib/mysql
      - ./master.cnf:/etc/mysql/conf.d/master.cnf
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: myapp
      MYSQL_USER: myuser
      MYSQL_PASSWORD: mypassword
    ports:
      - "3306:3306"
    restart: always

  slave:
    image: mysql:8.0
    command: --server-id=2 --relay-log=relay-bin --read-only=1
    volumes:
      - slave-data:/var/lib/mysql
      - ./slave.cnf:/etc/mysql/conf.d/slave.cnf
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: myapp
      MYSQL_USER: myuser
      MYSQL_PASSWORD: mypassword
    depends_on:
      - master
    ports:
      - "3307:3306"
    restart: always

volumes:
  master-data:
  slave-data:
```

### 12.2.6.2 PostgreSQL集群

```yaml
version: '3.8'

services:
  postgres-primary:
    image: postgres:15
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data
      - ./primary.conf:/etc/postgresql/postgresql.conf
    environment:
      POSTGRES_PASSWORD: root_password
      POSTGRES_DB: myapp
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
    ports:
      - "5432:5432"
    restart: always

  postgres-replica:
    image: postgres:15
    volumes:
      - postgres-replica-data:/var/lib/postgresql/data
      - ./replica.conf:/etc/postgresql/postgresql.conf
    environment:
      POSTGRES_PASSWORD: root_password
      POSTGRES_DB: myapp
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_REPLICATION_USER: replication
      POSTGRES_REPLICATION_PASSWORD: replication_password
    depends_on:
      - postgres-primary
    ports:
      - "5433:5432"
    restart: always

  pgpool:
    image: bitnami/pgpool:4.4
    ports:
      - "5434:5432"
    environment:
      PGPOOL_BACKEND_NODES: "0:postgres-primary:5432,1:postgres-replica:5432"
      PGPOOL_SR_CHECK_USER: replication
      PGPOOL_SR_CHECK_PASSWORD: replication_password
      PGPOOL_ENABLE_LOAD_BALANCING: "yes"
      PGPOOL_POSTGRES_USERNAME: myuser
      PGPOOL_POSTGRES_PASSWORD: mypassword
      PGPOOL_ADMIN_USERNAME: admin
      PGPOOL_ADMIN_PASSWORD: admin_password
    depends_on:
      - postgres-primary
      - postgres-replica
    restart: always

volumes:
  postgres-primary-data:
  postgres-replica-data:
```

## 12.2.7 监控与日志示例

### 12.2.7.1 Prometheus + Grafana + cAdvisor

```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:v2.43.0
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    restart: always

  grafana:
    image: grafana/grafana:9.4.7
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    restart: always

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.0
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    ports:
      - "8080:8080"
    restart: always

  node-exporter:
    image: prom/node-exporter:v1.5.0
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "9100:9100"
    restart: always

volumes:
  prometheus-data:
  grafana-data:
```

### 12.2.7.2 ELK Stack

```yaml
version: '3.8'

services:
  elasticsearch:
    image: elasticsearch:8.7.0
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    restart: always

  logstash:
    image: logstash:8.7.0
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    environment:
      - LS_JAVA_OPTS=-Xms256m -Xmx256m
    depends_on:
      - elasticsearch
    ports:
      - "5044:5044"
    restart: always

  kibana:
    image: kibana:8.7.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    ports:
      - "5601:5601"
    restart: always

  filebeat:
    image: elastic/filebeat:8.7.0
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - logstash
    restart: always

volumes:
  elasticsearch-data:
```

## 12.2.8 最佳实践示例

### 12.2.8.1 多环境配置

```yaml
# docker-compose.yml - 基础配置
version: '3.8'

services:
  web:
    image: myapp/web:1.0
    ports:
      - "80:80"
    volumes:
      - static-volume:/app/static
    depends_on:
      - api
    restart: always

  api:
    image: myapp/api:1.0
    ports:
      - "3001:3001"
    depends_on:
      - db
      - redis
    restart: always

  db:
    image: postgres:15
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: always

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    restart: always

volumes:
  postgres-data:
  redis-data:
  static-volume:
```

```yaml
# docker-compose.dev.yml - 开发环境配置
version: '3.8'

services:
  web:
    build:
      context: ./web
      dockerfile: Dockerfile.dev
    volumes:
      - ./web:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - API_URL=http://api:3001

  api:
    build:
      context: ./api
      dockerfile: Dockerfile.dev
    volumes:
      - ./api:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - DB_URL=postgresql://postgres:postgres@db:5432/myapp
      - REDIS_URL=redis://redis:6379

  db:
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

  redis:
    ports:
      - "6379:6379"
```

```yaml
# docker-compose.prod.yml - 生产环境配置
version: '3.8'

services:
  web:
    environment:
      - NODE_ENV=production
      - API_URL=http://api:3001
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  api:
    environment:
      - NODE_ENV=production
      - DB_URL=postgresql://myapp:myapp@db:5432/myapp
      - REDIS_URL=redis://redis:6379
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "1"
          memory: 512M

  db:
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: myapp
      POSTGRES_PASSWORD: myapp
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 1G

  redis:
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
```

## 12.2.9 使用指南

### 12.2.9.1 启动服务

```bash
# 启动基础服务
docker-compose up -d

# 启动开发环境服务
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# 启动生产环境服务
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### 12.2.9.2 扩展服务

```bash
# 扩展 web 服务到 3 个实例
docker-compose up -d --scale web=3

# 在生产环境中扩展服务
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --scale web=3 --scale api=2
```

### 12.2.9.3 监控服务

```bash
# 查看服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f web

# 查看服务状态
docker-compose ps

# 查看服务资源使用情况
docker-compose stats
```

## 12.2.10 最佳实践

1. **使用版本固定的镜像**：避免使用 `latest` 标签
2. **使用命名卷**：便于管理和备份
3. **配置合理的重启策略**：确保服务自动恢复
4. **使用多环境配置**：分离基础配置和环境特定配置
5. **配置资源限制**：避免单个服务消耗过多资源
6. **使用健康检查**：确保服务正常运行
7. **配置依赖关系**：使用 `depends_on` 管理服务启动顺序
8. **使用网络隔离**：不同服务使用不同网络
9. **监控服务日志**：集中管理和分析日志
10. **自动化部署**：将 Docker Compose 集成到 CI/CD 流程

这些示例涵盖了不同应用场景的 docker-compose.yml 配置，您可以根据自己的项目需求进行修改和扩展。