# 10. 常见问题解决方案

## 10.1 权限问题

### 10.1.1 容器无法访问文件或目录

#### 问题描述
容器内的应用无法访问挂载的文件或目录，出现权限拒绝错误。

#### 解决方案

```bash
# 1. 检查宿主机文件或目录权限
sudo ls -la <host_path>

# 2. 调整宿主机文件或目录权限
sudo chmod -R 775 <host_path>
sudo chown -R <uid>:<gid> <host_path>

# 3. 运行容器时指定用户
docker run -d --name <container_name> -u <uid>:<gid> -v <host_path>:<container_path> <image_name>

# 4. 使用 root 用户运行容器（不推荐）
docker run -d --name <container_name> --user root -v <host_path>:<container_path> <image_name>

# 5. 在 Dockerfile 中指定用户
# Dockerfile
FROM <base_image>
RUN useradd -m -u 1000 myuser
USER myuser
```

#### 示例
```bash
# 调整宿主机目录权限
sudo chown -R 1000:1000 ./html

# 运行容器时指定用户
docker run -d --name nginx -u 1000:1000 -v ./html:/usr/share/nginx/html -p 80:80 nginx:alpine
```

### 10.1.2 Docker 命令需要 sudo 权限

#### 问题描述
执行 Docker 命令时需要使用 sudo 权限，否则出现权限拒绝错误。

#### 解决方案

```bash
# 1. 将当前用户添加到 docker 组
sudo usermod -aG docker $USER

# 2. 刷新用户组
su - $USER

# 3. 验证是否可以不使用 sudo 执行 docker 命令
docker info
```

### 10.1.3 容器内进程权限不足

#### 问题描述
容器内的进程无法执行某些操作，如绑定特权端口（< 1024）。

#### 解决方案

```bash
# 1. 使用 CAP_NET_BIND_SERVICE 能力
docker run -d --name <container_name> --cap-add NET_BIND_SERVICE <image_name>

# 2. 使用特权模式（不推荐）
docker run -d --name <container_name> --privileged <image_name>

# 3. 修改容器内端口映射
docker run -d --name <container_name> -p 8080:80 <image_name>
```

## 10.2 网络问题

### 10.2.1 容器无法访问外部网络

#### 问题描述
容器无法访问外部网络，如 ping 或 curl 外部地址失败。

#### 解决方案

```bash
# 1. 检查容器网络配置
docker inspect <container_name> | grep -A 20 "Networks"

# 2. 测试容器内部网络
docker exec <container_name> ping -c 3 localhost

# 3. 测试容器 DNS 配置
docker exec <container_name> cat /etc/resolv.conf
docker exec <container_name> nslookup www.baidu.com

# 4. 检查 Docker 网络配置
docker network inspect bridge

# 5. 检查 iptables 规则
sudo iptables -L -n

# 6. 重启 Docker 服务
systemctl restart docker

# 7. 配置 Docker 守护进程的 DNS
echo '{"dns": ["8.8.8.8", "8.8.4.4"]}' > /etc/docker/daemon.json
systemctl restart docker
```

### 10.2.2 外部无法访问容器端口

#### 问题描述
外部无法访问容器映射的端口，如浏览器无法访问容器内的 web 服务。

#### 解决方案

```bash
# 1. 检查端口映射配置
docker port <container_name>

# 2. 检查容器是否运行
docker ps

# 3. 检查宿主机端口占用
sudo netstat -tuln | grep <port>

# 4. 检查宿主机防火墙
sudo ufw status
sudo iptables -L -n

# 5. 测试本地访问
curl http://localhost:<port>

# 6. 检查容器内服务是否正常运行
docker exec <container_name> ps aux

# 7. 检查容器内服务日志
docker logs <container_name>
```

### 10.2.3 容器间无法通信

#### 问题描述
同一网络中的容器无法相互通信，如服务 A 无法访问服务 B。

#### 解决方案

```bash
# 1. 检查容器是否在同一网络
docker inspect <container1> | grep -A 10 "Networks"
docker inspect <container2> | grep -A 10 "Networks"

# 2. 创建自定义网络
docker network create <network_name>

# 3. 将容器连接到同一网络
docker run -d --name <container1> --network <network_name> <image1>
docker run -d --name <container2> --network <network_name> <image2>

# 4. 测试容器间通信
docker exec <container1> ping -c 3 <container2_name>

# 5. 检查网络配置
docker network inspect <network_name>
```

## 10.3 存储问题

### 10.3.1 数据卷数据丢失

#### 问题描述
容器停止或删除后，数据卷中的数据丢失。

#### 解决方案

```bash
# 1. 检查数据卷是否存在
docker volume ls

# 2. 检查数据卷挂载情况
docker inspect <container_name> | grep -A 20 "Mounts"

# 3. 避免使用 tmpfs 挂载（临时存储）
# tmpfs 挂载的数据在容器停止后会丢失

# 4. 定期备份数据卷
docker run --rm -v <volume_name>:<container_path> -v $(pwd):/backup alpine tar cvf /backup/<backup_name>.tar <container_path>

# 5. 使用命名卷而非绑定挂载
docker run -d --name <container_name> -v <volume_name>:<container_path> <image_name>
```

### 10.3.2 磁盘空间不足

#### 问题描述
Docker 占用过多磁盘空间，导致宿主机磁盘空间不足。

#### 解决方案

```bash
# 1. 查看 Docker 磁盘使用情况
docker system df

# 2. 清理未使用的资源
docker system prune
docker system prune -a --volumes

# 3. 清理未使用的镜像
docker image prune
docker image prune -a

# 4. 清理未使用的容器
docker container prune

# 5. 清理未使用的数据卷
docker volume prune

# 6. 清理未使用的网络
docker network prune

# 7. 调整 Docker 数据存储路径
echo '{"data-root": "/new/path/docker"}' > /etc/docker/daemon.json
systemctl restart docker
```

### 10.3.3 数据卷挂载失败

#### 问题描述
容器启动时数据卷挂载失败，出现挂载错误。

#### 解决方案

```bash
# 1. 检查数据卷是否存在
docker volume ls

# 2. 检查宿主机路径是否存在
sudo ls -la <host_path>

# 3. 检查宿主机路径权限
sudo chmod -R 775 <host_path>

# 4. 检查容器内路径是否存在
docker run --rm <image_name> ls -la <container_path>

# 5. 检查 Docker 日志
docker logs <container_name>

# 6. 使用绝对路径挂载
docker run -d --name <container_name> -v $(pwd)/<relative_path>:<container_path> <image_name>
```

## 10.4 镜像拉取问题

### 10.4.1 镜像拉取超时

#### 问题描述
拉取镜像时超时，无法下载镜像。

#### 解决方案

```bash
# 1. 检查网络连接
ping -c 3 registry-1.docker.io

# 2. 使用国内镜像加速源
echo '{"registry-mirrors": ["https://registry.docker-cn.com", "https://docker.mirrors.ustc.edu.cn", "https://hub-mirror.c.163.com"]}' > /etc/docker/daemon.json
systemctl restart docker

# 3. 增加拉取超时时间
docker pull --timeout 300 <image_name>

# 4. 手动下载镜像后导入
docker save -o <image_name>.tar <image_name>
docker load -i <image_name>.tar
```

### 10.4.2 镜像拉取权限不足

#### 问题描述
拉取私有镜像时，出现权限不足错误。

#### 解决方案

```bash
# 1. 登录镜像仓库
docker login <registry_url>

# 2. 检查镜像名称和标签是否正确
docker pull <registry_url>/<image_name>:<tag>

# 3. 检查用户权限
# 确保用户有拉取该镜像的权限

# 4. 使用正确的认证信息
# 检查 Docker 配置文件中的认证信息
cat ~/.docker/config.json
```

### 10.4.3 镜像不存在

#### 问题描述
拉取镜像时，出现镜像不存在错误。

#### 解决方案

```bash
# 1. 检查镜像名称和标签是否正确
docker pull <image_name>:<tag>

# 2. 搜索可用镜像
docker search <keyword>

# 3. 检查镜像仓库地址是否正确
docker pull <registry_url>/<image_name>:<tag>

# 4. 构建自己的镜像
# 创建 Dockerfile 并构建镜像
docker build -t <image_name>:<tag> .
```

## 10.5 容器启动问题

### 10.5.1 容器启动后立即退出

#### 问题描述
容器启动后立即退出，无法保持运行。

#### 解决方案

```bash
# 1. 查看容器日志
docker logs <container_name>

# 2. 检查容器启动命令
docker inspect <container_name> | grep -A 10 "Cmd"

# 3. 确保容器有持续运行的进程
docker run -d --name <container_name> <image_name> <command>

# 4. 查看容器状态
docker ps -a

# 5. 交互式运行容器，查看具体错误
docker run -it --name <container_name> <image_name> <command>
```

### 10.5.2 容器启动失败，显示端口已被占用

#### 问题描述
容器启动时，出现端口已被占用错误。

#### 解决方案

```bash
# 1. 检查端口占用情况
sudo netstat -tuln | grep <port>

# 2. 停止占用端口的进程
sudo kill <pid>

# 3. 修改容器端口映射
docker run -d --name <container_name> -p <new_host_port>:<container_port> <image_name>

# 4. 检查是否有其他容器占用该端口
docker ps | grep <port>
```

## 10.6 Docker 服务问题

### 10.6.1 Docker 服务无法启动

#### 问题描述
Docker 服务启动失败，无法正常运行。

#### 解决方案

```bash
# 1. 查看 Docker 服务日志
journalctl -u docker.service

# 2. 检查 Docker 配置文件
cat /etc/docker/daemon.json

# 3. 检查 Docker 数据目录权限
sudo ls -la /var/lib/docker

# 4. 检查磁盘空间
df -h

# 5. 检查内存使用
free -h

# 6. 重置 Docker 服务
systemctl stop docker
sudo rm -rf /var/lib/docker
systemctl start docker
```

### 10.6.2 Docker 命令执行缓慢

#### 问题描述
执行 Docker 命令时响应缓慢，如 `docker ps` 命令需要很长时间才能返回结果。

#### 解决方案

```bash
# 1. 检查 Docker 服务状态
systemctl status docker

# 2. 检查系统资源使用情况
top

# 3. 清理未使用的资源
docker system prune
docker system prune -a --volumes

# 4. 重启 Docker 服务
systemctl restart docker

# 5. 检查 Docker 守护进程日志
docker logs docker
```

## 10.7 常见问题排查流程

### 10.7.1 通用排查流程

1. **查看日志**：查看容器日志和 Docker 服务日志
2. **检查状态**：检查容器状态、网络状态和服务状态
3. **验证配置**：验证 Docker 配置和容器配置
4. **测试连接**：测试网络连接和服务可用性
5. **检查资源**：检查系统资源使用情况
6. **重启服务**：尝试重启 Docker 服务或容器
7. **搜索解决方案**：根据错误信息搜索解决方案

### 10.7.2 日志查看命令

```bash
# 查看容器日志
docker logs <container_name>
docker logs -f <container_name>
docker logs --tail 100 <container_name>

# 查看 Docker 服务日志
journalctl -u docker.service
journalctl -u docker.service --since "10m"

# 查看系统日志
dmesg | grep -i docker
```

通过本章节的学习，您已经掌握了 Docker 常见问题的解决方案，包括权限问题、网络问题、存储问题、镜像拉取问题等。在实际使用中，遇到问题时可以按照通用排查流程进行排查，结合具体问题选择合适的解决方案。