# 12. 附录

## 12.1 Dockerfile 示例

### 12.1.1 基础镜像示例

#### 12.1.1.1 Alpine 基础镜像

```dockerfile
FROM alpine:3.18

RUN apk update && \    apk add --no-cache \        curl \        wget \        git \        bash \        && rm -rf /var/cache/apk/*

CMD ["bash"]
```

#### 12.1.1.2 Debian 基础镜像

```dockerfile
FROM debian:buster-slim

RUN apt-get update && \    apt-get install -y \        curl \        wget \        git \        bash \        && apt-get clean \        && rm -rf /var/lib/apt/lists/*

CMD ["bash"]
```

### 12.1.2 应用镜像示例

#### 12.1.2.1 Python 应用

```dockerfile
# 使用多阶段构建

# 第一阶段：构建阶段
FROM python:3.11-slim AS builder

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 第二阶段：运行阶段
FROM python:3.11-slim

WORKDIR /app

# 从构建阶段复制依赖
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# 复制应用代码
COPY --from=builder /app /app

# 创建非 root 用户
RUN useradd -m -u 1000 myapp
USER myapp

# 暴露端口
EXPOSE 8000

# 启动应用
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 12.1.2.2 Node.js 应用

```dockerfile
# 第一阶段：构建阶段
FROM node:18-alpine AS builder

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm install

# 复制应用代码
COPY . .

# 构建应用
RUN npm run build

# 第二阶段：运行阶段
FROM node:18-alpine

WORKDIR /app

# 从构建阶段复制构建产物
COPY --from=builder /app/dist /app/dist
COPY --from=builder /app/package*.json ./

# 安装生产依赖
RUN npm install --production

# 创建非 root 用户
RUN adduser -D -u 1000 myapp
USER myapp

# 暴露端口
EXPOSE 3000

# 启动应用
CMD ["node", "dist/index.js"]
```

#### 12.1.2.3 Go 应用

```dockerfile
# 第一阶段：构建阶段
FROM golang:1.20-alpine AS builder

WORKDIR /app

# 复制 Go 模块文件
COPY go.mod go.sum ./
RUN go mod download

# 复制应用代码
COPY . .

# 构建应用
RUN CGO_ENABLED=0 GOOS=linux go build -o myapp .

# 第二阶段：运行阶段
FROM alpine:3.18

WORKDIR /app

# 从构建阶段复制应用
COPY --from=builder /app/myapp /app/myapp

# 创建非 root 用户
RUN adduser -D -u 1000 myapp
USER myapp

# 暴露端口
EXPOSE 8080

# 启动应用
CMD ["./myapp"]
```

#### 12.1.2.4 Java 应用

```dockerfile
# 第一阶段：构建阶段
FROM maven:3.9-eclipse-temurin-17 AS builder

WORKDIR /app

# 复制 Maven 配置文件
COPY pom.xml .
RUN mvn dependency:go-offline

# 复制应用代码
COPY src ./src

# 构建应用
RUN mvn package -DskipTests

# 第二阶段：运行阶段
FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

# 从构建阶段复制应用
COPY --from=builder /app/target/myapp.jar /app/myapp.jar

# 创建非 root 用户
RUN adduser -D -u 1000 myapp
USER myapp

# 暴露端口
EXPOSE 8080

# 启动应用
CMD ["java", "-jar", "myapp.jar"]
```

### 12.1.3 Web 服务器示例

#### 12.1.3.1 Nginx

```dockerfile
FROM nginx:alpine

# 复制自定义配置
COPY nginx.conf /etc/nginx/nginx.conf
COPY default.conf /etc/nginx/conf.d/default.conf

# 复制静态文件
COPY html /usr/share/nginx/html

# 创建非 root 用户
RUN adduser -D -u 1000 nginx-user
RUN chown -R nginx-user:nginx-user /usr/share/nginx/html

# 暴露端口
EXPOSE 80 443

# 启动 Nginx
CMD ["nginx", "-g", "daemon off;"]
```

#### 12.1.3.2 Apache

```dockerfile
FROM httpd:2.4-alpine

# 复制自定义配置
COPY httpd.conf /usr/local/apache2/conf/httpd.conf
COPY virtual-host.conf /usr/local/apache2/conf/extra/httpd-vhosts.conf

# 复制静态文件
COPY html /usr/local/apache2/htdocs

# 创建非 root 用户
RUN adduser -D -u 1000 apache-user
RUN chown -R apache-user:apache-user /usr/local/apache2/htdocs

# 暴露端口
EXPOSE 80 443

# 启动 Apache
CMD ["httpd", "-D", "FOREGROUND"]
```

## 12.2 docker-compose.yml 示例

### 12.2.1 基础示例

```yaml
version: '3.8'

services:
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./html:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    restart: always
    networks:
      - my-network

  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: myapp
      MYSQL_USER: myapp
      MYSQL_PASSWORD: myapp123
    volumes:
      - mysql-data:/var/lib/mysql
    restart: always
    networks:
      - my-network

volumes:
  mysql-data:
    driver: local

networks:
  my-network:
    driver: bridge
```

### 12.2.2 Python Web 应用

```yaml
version: '3.8'

services:
  web:
    build: ./web
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
    environment:
      - DATABASE_URL=mysql+pymysql://myapp:myapp123@db:3306/myapp
      - REDIS_URL=redis://redis:6379/0
    restart: always
    networks:
      - my-network

  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: myapp
      MYSQL_USER: myapp
      MYSQL_PASSWORD: myapp123
    volumes:
      - mysql-data:/var/lib/mysql
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: always
    networks:
      - my-network

  redis:
    image: redis:alpine
    volumes:
      - redis-data:/data
    restart: always
    networks:
      - my-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - web
    restart: always
    networks:
      - my-network

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local

networks:
  my-network:
    driver: bridge
```

### 12.2.3 Node.js Web 应用

```yaml
version: '3.8'

services:
  app:
    build: ./app
    ports:
      - "3000:3000"
    depends_on:
      - mongo
      - redis
    environment:
      - MONGO_URL=mongodb://mongo:27017/myapp
      - REDIS_URL=redis://redis:6379/0
    restart: always
    networks:
      - my-network

  mongo:
    image: mongo:5.0
    volumes:
      - mongo-data:/data/db
    restart: always
    networks:
      - my-network

  redis:
    image: redis:alpine
    volumes:
      - redis-data:/data
    restart: always
    networks:
      - my-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - app
    restart: always
    networks:
      - my-network

volumes:
  mongo-data:
    driver: local
  redis-data:
    driver: local

networks:
  my-network:
    driver: bridge
```

### 12.2.4 微服务架构

```yaml
version: '3.8'

services:
  # API 网关
  gateway:
    build: ./gateway
    ports:
      - "80:80"
    depends_on:
      - user-service
      - order-service
      - product-service
    restart: always
    networks:
      - my-network

  # 用户服务
  user-service:
    build: ./user-service
    depends_on:
      - user-db
      - rabbitmq
    environment:
      - DATABASE_URL=postgresql://user:password@user-db:5432/userdb
      - RABBITMQ_URL=amqp://rabbitmq:5672/
    restart: always
    networks:
      - my-network

  # 订单服务
  order-service:
    build: ./order-service
    depends_on:
      - order-db
      - rabbitmq
    environment:
      - DATABASE_URL=postgresql://user:password@order-db:5432/orderdb
      - RABBITMQ_URL=amqp://rabbitmq:5672/
    restart: always
    networks:
      - my-network

  # 产品服务
  product-service:
    build: ./product-service
    depends_on:
      - product-db
      - rabbitmq
    environment:
      - DATABASE_URL=postgresql://user:password@product-db:5432/productdb
      - RABBITMQ_URL=amqp://rabbitmq:5672/
    restart: always
    networks:
      - my-network

  # 数据库
  user-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=userdb
    volumes:
      - user-db-data:/var/lib/postgresql/data
    restart: always
    networks:
      - my-network

  order-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=orderdb
    volumes:
      - order-db-data:/var/lib/postgresql/data
    restart: always
    networks:
      - my-network

  product-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=productdb
    volumes:
      - product-db-data:/var/lib/postgresql/data
    restart: always
    networks:
      - my-network

  # 消息队列
  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    restart: always
    networks:
      - my-network

  # 缓存
  redis:
    image: redis:alpine
    volumes:
      - redis-data:/data
    restart: always
    networks:
      - my-network

volumes:
  user-db-data:
    driver: local
  order-db-data:
    driver: local
  product-db-data:
    driver: local
  rabbitmq-data:
    driver: local
  redis-data:
    driver: local

networks:
  my-network:
    driver: bridge
```

## 12.3 常用 Docker 镜像

### 12.3.1 基础镜像

| 镜像名称 | 描述 | 标签 | 大小 | 用途 |
|---------|------|------|------|------|
| `alpine` | 基于 Alpine Linux 的轻量级镜像 | `3.18` | ~5MB | 轻量级应用基础镜像 |
| `debian` | Debian Linux 镜像 | `buster-slim` | ~69MB | 需要完整 Debian 环境的应用 |
| `ubuntu` | Ubuntu Linux 镜像 | `22.04` | ~77MB | 需要 Ubuntu 环境的应用 |
| `centos` | CentOS Linux 镜像 | `stream8` | ~231MB | 需要 CentOS 环境的企业应用 |

### 12.3.2 开发语言镜像

| 镜像名称 | 描述 | 标签 | 大小 | 用途 |
|---------|------|------|------|------|
| `python` | Python 开发环境 | `3.11-slim` | ~120MB | Python 应用开发和运行 |
| `node` | Node.js 开发环境 | `18-alpine` | ~170MB | Node.js 应用开发和运行 |
| `golang` | Go 开发环境 | `1.20-alpine` | ~300MB | Go 应用开发和运行 |
| `openjdk` | Java 开发环境 | `17-jdk-slim` | ~400MB | Java 应用开发和运行 |
| `maven` | Maven 构建工具 | `3.9-eclipse-temurin-17` | ~650MB | Java 应用构建 |
| `gradle` | Gradle 构建工具 | `8.2-jdk17-alpine` | ~500MB | Java 应用构建 |
| `dotnet` | .NET 开发环境 | `6.0-sdk-alpine` | ~300MB | .NET 应用开发和运行 |

### 12.3.3 数据库镜像

| 镜像名称 | 描述 | 标签 | 大小 | 用途 |
|---------|------|------|------|------|
| `mysql` | MySQL 数据库 | `8.0` | ~500MB | 关系型数据库 |
| `postgres` | PostgreSQL 数据库 | `15` | ~300MB | 关系型数据库 |
| `mongo` | MongoDB 数据库 | `5.0` | ~700MB | 文档型数据库 |
| `redis` | Redis 缓存 | `7.0-alpine` | ~30MB | 键值存储、缓存 |
| `elasticsearch` | Elasticsearch 搜索引擎 | `8.8.0` | ~1.1GB | 搜索引擎、日志分析 |
| `cassandra` | Cassandra 数据库 | `4.1` | ~400MB | 分布式数据库 |
| `neo4j` | Neo4j 图数据库 | `5.8` | ~500MB | 图数据库 |

### 12.3.4 Web 服务器镜像

| 镜像名称 | 描述 | 标签 | 大小 | 用途 |
|---------|------|------|------|------|
| `nginx` | Nginx Web 服务器 | `1.25-alpine` | ~40MB | Web 服务器、反向代理 |
| `httpd` | Apache Web 服务器 | `2.4-alpine` | ~150MB | Web 服务器、反向代理 |
| `traefik` | Traefik 反向代理 | `v2.9` | ~90MB | 现代反向代理、负载均衡 |
| `caddy` | Caddy Web 服务器 | `2.6-alpine` | ~40MB | 自动 HTTPS Web 服务器 |

### 12.3.5 消息队列镜像

| 镜像名称 | 描述 | 标签 | 大小 | 用途 |
|---------|------|------|------|------|
| `rabbitmq` | RabbitMQ 消息队列 | `3.12-management-alpine` | ~180MB | 消息队列、AMQP 协议 |
| `kafka` | Apache Kafka 消息队列 | `3.4` | ~600MB | 分布式消息队列 |
| `nats` | NATS 消息系统 | `2.9-alpine` | ~15MB | 高性能消息系统 |
| `activemq` | Apache ActiveMQ 消息队列 | `5.17-alpine` | ~200MB | 消息队列、JMS 协议 |

### 12.3.6 监控与日志镜像

| 镜像名称 | 描述 | 标签 | 大小 | 用途 |
|---------|------|------|------|------|
| `prom/prometheus` | Prometheus 监控系统 | `v2.44` | ~200MB | 监控数据采集和存储 |
| `grafana/grafana` | Grafana 可视化平台 | `9.5` | ~300MB | 监控数据可视化 |
| `google/cadvisor` | cAdvisor 容器监控 | `v0.47` | ~60MB | 容器资源监控 |
| `elastic/filebeat` | Filebeat 日志采集 | `8.8.0` | ~100MB | 日志采集 |
| `elastic/metricbeat` | Metricbeat 指标采集 | `8.8.0` | ~100MB | 指标采集 |
| `fluent/fluentd` | Fluentd 日志聚合 | `v1.16-alpine` | ~100MB | 日志聚合和转发 |
| `jaegertracing/all-in-one` | Jaeger 分布式追踪 | `1.46` | ~150MB | 分布式追踪系统 |

### 12.3.7 DevOps 工具镜像

| 镜像名称 | 描述 | 标签 | 大小 | 用途 |
|---------|------|------|------|------|
| `gitlab/gitlab-ce` | GitLab 代码托管 | `16.0.0-ce.0` | ~2.5GB | 代码托管、CI/CD |
| `jenkins/jenkins` | Jenkins CI/CD | `lts-alpine` | ~400MB | CI/CD 流水线 |
| `argoproj/argocd` | Argo CD | `v2.7` | ~120MB | GitOps 持续部署 |
| `hashicorp/terraform` | Terraform | `1.5-alpine` | ~100MB | 基础设施即代码 |
| `ansible/ansible` | Ansible | `latest` | ~400MB | 配置管理、自动化 |
| `hashicorp/vault` | Vault 密钥管理 | `1.13-alpine` | ~100MB | 密钥和机密管理 |

### 12.3.8 工具镜像

| 镜像名称 | 描述 | 标签 | 大小 | 用途 |
|---------|------|------|------|------|
| `busybox` | 包含常用 Unix 命令的轻量级镜像 | `latest` | ~1MB | 调试、测试 |
| `curlimages/curl` | 包含 curl 命令的镜像 | `latest` | ~10MB | HTTP 请求、API 测试 |
| `wget/wget` | 包含 wget 命令的镜像 | `latest` | ~10MB | 文件下载 |
| `alpine/git` | 包含 git 命令的镜像 | `latest` | ~40MB | Git 操作 |
| `postgres:15-alpine` | 包含 psql 命令的镜像 | `15-alpine` | ~150MB | PostgreSQL 客户端 |
| `mysql:8.0` | 包含 mysql 命令的镜像 | `8.0` | ~500MB | MySQL 客户端 |

## 12.4 Dockerfile 最佳实践总结

1. **使用多阶段构建**：减少最终镜像大小，分离构建环境和运行环境
2. **使用官方镜像**：优先使用官方或经过验证的镜像
3. **使用最小化基础镜像**：如 alpine、slim 等，减少攻击面
4. **合理安排指令顺序**：利用 Docker 缓存机制，提高构建速度
5. **清理构建缓存**：在构建过程中清理临时文件，减少镜像大小
6. **使用 .dockerignore 文件**：排除不必要的文件和目录，减少构建上下文
7. **指定明确的标签**：避免使用 latest 标签，使用具体版本号
8. **创建非 root 用户**：在容器中使用非 root 用户运行应用，提高安全性
9. **配置健康检查**：添加 HEALTHCHECK 指令，监控容器健康状态
10. **暴露必要端口**：使用 EXPOSE 指令暴露容器端口
11. **使用 COPY 而非 ADD**：COPY 更安全，功能更明确
12. **设置工作目录**：使用 WORKDIR 指令设置容器工作目录
13. **避免在容器中存储敏感数据**：敏感数据应通过环境变量或外部存储提供

## 12.5 docker-compose.yml 最佳实践总结

1. **使用明确的版本**：指定 Compose 文件版本，如 3.8
2. **使用服务名称作为主机名**：利用 Docker 内置 DNS 服务发现
3. **使用命名卷**：优先使用命名卷而非绑定挂载，便于管理
4. **配置健康检查**：为服务添加健康检查，确保服务正常运行
5. **设置重启策略**：为服务配置合适的重启策略
6. **使用环境变量文件**：将敏感信息和配置项放在 .env 文件中
7. **配置资源限制**：为服务设置合理的资源限制，避免资源竞争
8. **使用网络隔离**：为不同服务配置不同网络，实现网络隔离
9. **分离配置文件**：使用多个 Compose 文件分离不同环境的配置
10. **使用依赖关系**：合理配置 depends_on，确保服务启动顺序
11. **使用构建上下文忽略**：为每个服务配置 .dockerignore 文件
12. **使用标签**：为服务添加标签，便于管理和监控

通过本附录的学习，您已经掌握了 Dockerfile 和 docker-compose.yml 的示例和最佳实践，以及常用的 Docker 镜像。这些示例和最佳实践可以帮助您更好地构建和管理 Docker 镜像和容器，提高 Docker 应用的安全性、可靠性和性能。