# 批量构建GraphRAG索引脚本

## 功能介绍

该脚本用于批量构建GraphRAG索引，支持对指定目录下的多个文件进行索引构建，为每个文件生成独立的索引目录，结构类似于示例目录 `/docs/mcp_rag_agent_graphrag_demo/doupocangqiong`。

## 脚本特点

1. **批量处理**：支持对目录下的多个文件进行批量索引构建
2. **配置灵活**：可指定配置文件模板目录，支持动态修改模型参数
3. **日志记录**：详细记录构建过程，便于排查问题
4. **结果统计**：提供成功和失败的统计信息
5. **支持多种文件模式**：可通过正则表达式匹配特定类型的文件

## 使用方法

### 前提条件

1. 已安装 Python 3.10-3.12
2. 已安装 `graphrag-more` 包：`pip install graphrag-more`
3. 已准备好配置文件模板目录，包含 `.env` 和 `settings.yaml` 文件

### 命令格式

```bash
python batch_build_index.py --input-dir <输入文件目录> --config-dir <配置文件模板目录> [选项]
```

### 命令参数

| 参数 | 简写 | 描述 | 必填 | 默认值 |
|------|------|------|------|--------|
| `--input-dir` | `-i` | 输入文件目录，包含需要构建索引的文件 | 是 | - |
| `--config-dir` | `-c` | 配置文件模板目录，包含 `.env` 和 `settings.yaml` | 是 | - |
| `--output-base` | `-o` | 输出基础目录，索引目录将在此目录下创建 | 否 | `./output` |
| `--file-pattern` | `-p` | 文件匹配模式，如 `*.txt` 或 `*.md` | 否 | `*.txt` |
| `--model` | `-m` | 指定LLM模型，如不指定则使用配置文件中的模型 | 否 | None |
| `--embedding-model` | - | 指定Embedding模型，如不指定则使用配置文件中的模型 | 否 | None |

### 示例命令

1. **基本用法**：

```bash
python batch_build_index.py -i ./input_files -c ./example_config -o ./output
```

2. **指定文件模式**：

```bash
python batch_build_index.py -i ./input_files -c ./example_config -p "*.md" -o ./output
```

3. **指定模型**：

```bash
python batch_build_index.py -i ./input_files -c ./example_config -m qwen-plus -o ./output
```

4. **完整参数示例**：

```bash
python batch_build_index.py \
  --input-dir ./input_files \
  --config-dir ./example_config \
  --output-base ./output \
  --file-pattern "*.txt" \
  --model qwen-plus \
  --embedding-model text-embedding-v2
```

## 脚本工作流程

1. **解析命令行参数**：获取用户指定的输入目录、配置目录、输出目录等参数
2. **遍历输入目录**：获取所有匹配文件模式的文件
3. **为每个文件创建索引目录**：在输出基础目录下创建以文件名（不含扩展名）命名的索引目录
4. **复制配置文件**：将配置文件模板复制到索引目录
5. **更新配置文件**：根据用户指定的模型参数更新配置文件（如果提供）
6. **准备输入数据**：将待处理文件复制到索引目录的 `input` 子目录
7. **执行构建索引命令**：调用 `graphrag index` 命令构建索引
8. **记录结果**：记录构建结果，统计成功和失败的数量

## 输出目录结构

执行脚本后，输出目录结构如下：

```
output/
├── file1/                 # 以文件名（不含扩展名）命名的索引目录
│   ├── .env               # 配置文件
│   ├── settings.yaml      # 配置文件
│   ├── input/             # 输入数据目录
│   │   └── file1.txt      # 待处理文件
│   ├── output/            # 索引输出目录
│   │   ├── lancedb/       # 向量数据库
│   │   └── ...            # 其他索引文件
│   ├── cache/             # 缓存目录
│   └── logs/              # 日志目录
├── file2/                 # 第二个文件的索引目录
│   └── ...                # 类似结构
└── ...
```

## 示例配置目录

脚本提供了一个示例配置目录 `example_config`，包含了从示例目录 `/docs/mcp_rag_agent_graphrag_demo/doupocangqiong` 复制过来的配置文件，您可以直接使用该目录作为配置模板，也可以根据需要修改其中的配置。

## 日志记录

脚本会生成日志文件 `batch_build_index.log`，记录构建过程中的详细信息，包括：

- 脚本执行时间
- 输入参数
- 处理的文件列表
- 每个文件的处理结果
- 构建成功和失败的统计信息

## 注意事项

1. 确保配置文件模板目录中包含有效的 `.env` 和 `settings.yaml` 文件
2. 确保输入目录中包含匹配的文件
3. 构建索引过程可能需要较长时间，具体取决于文件大小和数量
4. 构建过程中可能会触发 rate limit，建议根据需要调整配置文件中的 `requests_per_minute` 和 `concurrent_requests` 参数
5. 如遇到构建失败的情况，请查看日志文件 `batch_build_index.log` 获取详细错误信息

## 示例使用场景

1. **文档知识库构建**：对多个文档进行批量索引构建，生成可查询的知识库
2. **多文档分析**：对多个文档进行并行索引构建，提高分析效率
3. **模型测试**：使用不同的模型参数对同一组文件进行索引构建，比较不同模型的效果

## 常见问题

### Q: 脚本执行时提示找不到 `graphrag` 命令？
A: 请确保已安装 `graphrag-more` 包，并且该包的安装目录已添加到系统环境变量 `PATH` 中。

### Q: 构建索引时提示 API 密钥无效？
A: 请检查配置文件模板目录中的 `.env` 文件，确保 `GRAPHRAG_API_KEY` 配置正确。

### Q: 构建索引时提示模型不支持？
A: 请检查配置文件中的模型名称是否正确，或者通过 `--model` 参数指定支持的模型。

### Q: 构建索引速度很慢？
A: 可以尝试调整配置文件中的 `requests_per_minute` 和 `concurrent_requests` 参数，或者减少同时处理的文件数量。

## 扩展建议

1. 支持更多的配置文件自定义选项
2. 支持分布式构建，提高处理速度
3. 支持增量更新索引
4. 提供Web界面，便于可视化管理和监控构建过程
5. 支持更多的输出格式和统计信息
